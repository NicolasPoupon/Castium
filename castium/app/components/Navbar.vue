<script setup lang="ts">
import { useI18n } from "#imports"
import * as locales from "@nuxt/ui/locale"

const { t, locale, setLocale } = useI18n()
const route = useRoute()
const router = useRouter()
const { user, isAuthenticated, signOut, loading } = useAuth()
const toast = useToast()

const selectedLocale = computed({
    get: () => locale.value,
    set: async (value: string) => {
        await setLocale(value) // charge les messages si lazy
    },
})

const handleLogout = async () => {
    try {
        await signOut()
    } catch (error) {
        console.error("Logout error:", error)
        toast.add({
            title: t("navbar.user.logoutError") || "Erreur de dÃ©connexion",
            color: "error",
        })
    }
}

const props = defineProps({
    mode: {
        type: String,
        default: "landing", // landing | login | app
    },
})

const items = computed(() => [
    { label: t("navbar.selector.movies"), value: "movies", to: "/app/movies" },
    { label: t("navbar.selector.music"), value: "music", to: "/app/music" },
    {
        label: t("navbar.selector.podcasts"),
        value: "podcasts",
        to: "/app/podcasts",
    },
    {
        label: t("navbar.selector.lectures"),
        value: "lectures",
        to: "/app/lectures",
    },
])

const activeTab = computed({
    get() {
        if (route.path.includes("/music")) return "music"
        if (route.path.includes("/podcasts")) return "podcasts"
        if (route.path.includes("/lectures")) return "lectures"
        return "movies"
    },
    set(value: string) {
        const item = items.value.find((i) => i.value === value)
        if (item?.to) router.push(item.to)
    },
})

const modeClass = computed(() => {
    if (route.path.includes("/movies")) return "fill-red-800"
    if (route.path.includes("/music")) return "fill-green-600"
    if (route.path.includes("/podcasts")) return "fill-orange-400"
    if (route.path.includes("/lectures")) return "fill-purple-500"

    return "fill-gray-300"
})

// User profile helpers
const userName = computed(() => {
    if (!user.value) return ""
    const meta = user.value.user_metadata
    return (
        meta?.full_name || meta?.name || user.value.email?.split("@")[0] || ""
    )
})

const userInitials = computed(() => {
    const name = userName.value
    if (!name) return "?"
    const parts = name.split(" ")
    if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase()
    }
    return name.substring(0, 2).toUpperCase()
})

const userAvatar = computed(() => {
    if (!user.value) return null
    return (
        user.value.user_metadata?.avatar_url ||
        user.value.user_metadata?.picture ||
        null
    )
})

const userMenuItems = computed(() => [
    [
        {
            label: userName.value,
            slot: "account",
            disabled: true,
        },
    ],
    [
        {
            label: t("navbar.user.settings"),
            icon: "i-heroicons-cog-6-tooth",
            to: "/app/settings",
        },
    ],
    [
        {
            label: t("navbar.user.logout"),
            icon: "i-heroicons-arrow-right-on-rectangle",
            click: handleLogout,
        },
    ],
])
</script>

<template>
    <header
        class="fixed inset-x-0 top-0 z-50 bg-black/20 backdrop-blur-md py-2"
    >
        <div
            class="flex items-center justify-between gap-3 h-[--header-height] mx-auto px-4 md:px-6 lg:px-8"
        >
            <div class="flex items-center justify-start gap-4">
                <NuxtLink to="/">
                    <svg
                        class="h-10 transition-colors"
                        :class="modeClass"
                        viewBox="0 0 147 40"
                        aria-label="Castium Logo"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                            d="M2 0C7.30433 0 12.3914 2.10714 16.1421 5.85786C19.8929 9.60859 22 14.6957 22 20C22 25.3043 19.8929 30.3914 16.1421 34.1421C12.3914 37.8929 7.30433 40 2 40C1.46957 40 0.96086 39.7893 0.585787 39.4142C0.210714 39.0391 0 38.5304 0 38C0 37.4696 0.210714 36.9609 0.585787 36.5858C0.96086 36.2107 1.46957 36 2 36C6.24346 36 10.3131 34.3143 13.3137 31.3137C16.3143 28.3131 18 24.2435 18 20C18 15.7565 16.3143 11.6869 13.3137 8.68629C10.3131 5.68571 6.24346 4 2 4C1.46957 4 0.96086 3.78929 0.585787 3.41421C0.210714 3.03914 0 2.53043 0 2C0 1.46957 0.210714 0.96086 0.585787 0.585787C0.96086 0.210714 1.46957 0 2 0Z"
                        />
                        <path
                            d="M15.857 9.12794C15.4632 7.82855 17.1518 6.93978 18 8L26.0459 17.8339C26.6108 18.5243 26.6501 19.5053 26.1424 20.2388L18 32C17.3293 32.8942 15.9146 32.2271 16.178 31.1407L18.8716 20.0296C18.9557 19.6829 18.9454 19.3199 18.8419 18.9784L15.857 9.12794Z"
                        />
                        <path d="M0 12L12 20L0 28V12Z" />
                        <path
                            d="M52.642 15.7656H48.3466C48.3598 15.1955 48.2869 14.6918 48.1278 14.2543C47.9688 13.8101 47.7301 13.4323 47.4119 13.1207C47.1004 12.8092 46.7192 12.5739 46.2685 12.4148C45.8177 12.2491 45.3106 12.1662 44.7472 12.1662C43.66 12.1662 42.6624 12.438 41.7543 12.9815C40.8461 13.5251 40.0805 14.3139 39.4574 15.348C38.8343 16.3755 38.4034 17.6184 38.1648 19.0767C37.9328 20.482 37.946 21.6586 38.2045 22.6065C38.4631 23.5545 38.9205 24.2704 39.5767 24.7543C40.2396 25.2315 41.0649 25.4702 42.0526 25.4702C42.6624 25.4702 43.2424 25.3939 43.7926 25.2415C44.3428 25.0824 44.8433 24.857 45.294 24.5653C45.7514 24.267 46.1491 23.9058 46.4872 23.4815C46.8319 23.0573 47.1004 22.5767 47.2926 22.0398H51.6179C51.3461 22.9744 50.9219 23.8759 50.3452 24.7443C49.7751 25.6127 49.0691 26.3883 48.2273 27.071C47.3854 27.7472 46.4276 28.2841 45.3537 28.6818C44.2798 29.0795 43.1032 29.2784 41.8239 29.2784C39.9744 29.2784 38.3868 28.8542 37.0611 28.0057C35.742 27.1572 34.7907 25.9342 34.2074 24.3366C33.6241 22.7391 33.5147 20.8134 33.8793 18.5597C34.2438 16.3788 34.9564 14.5294 36.017 13.0114C37.0843 11.4867 38.3802 10.33 39.9048 9.54119C41.4361 8.75237 43.0734 8.35795 44.8168 8.35795C46.0298 8.35795 47.1269 8.52367 48.108 8.85511C49.089 9.18655 49.9242 9.67045 50.6136 10.3068C51.3097 10.9366 51.8333 11.7088 52.1847 12.6236C52.536 13.5384 52.6884 14.5857 52.642 15.7656ZM57.7876 29.2884C56.8198 29.2884 55.9813 29.1193 55.272 28.7812C54.5694 28.4366 54.0523 27.9261 53.7209 27.25C53.3894 26.5739 53.3066 25.7353 53.4723 24.7344C53.6181 23.8859 53.8932 23.1766 54.2976 22.6065C54.7086 22.0298 55.209 21.5658 55.799 21.2145C56.389 20.8632 57.0419 20.5947 57.7578 20.4091C58.4804 20.2235 59.2261 20.0975 59.995 20.0312C60.8833 19.9384 61.6058 19.849 62.1626 19.7628C62.7261 19.6766 63.147 19.554 63.4254 19.3949C63.7038 19.2292 63.8729 18.9839 63.9325 18.6591V18.5994C64.032 17.9763 63.916 17.4924 63.5845 17.1477C63.2597 16.7964 62.7393 16.6207 62.0234 16.6207C61.2678 16.6207 60.6248 16.7865 60.0945 17.1179C59.5708 17.4493 59.1963 17.8703 58.9709 18.3807L55.1129 18.0625C55.4576 17.1345 55.978 16.3324 56.674 15.6562C57.3767 14.9735 58.2218 14.4498 59.2095 14.0852C60.1972 13.714 61.3042 13.5284 62.5305 13.5284C63.379 13.5284 64.1712 13.6278 64.907 13.8267C65.6494 14.0256 66.2891 14.3338 66.826 14.7514C67.3696 15.169 67.7607 15.706 67.9993 16.3622C68.2446 17.0118 68.2943 17.7907 68.1484 18.6989L66.4283 29H62.4112L62.7692 26.8821H62.6499C62.325 27.3594 61.9273 27.7803 61.4567 28.1449C60.986 28.5028 60.4458 28.7846 59.8359 28.9901C59.2261 29.1889 58.5433 29.2884 57.7876 29.2884ZM59.4879 26.3651C60.1044 26.3651 60.6712 26.2424 61.1882 25.9972C61.7119 25.7453 62.1428 25.4072 62.4808 24.983C62.8255 24.5587 63.0443 24.0781 63.1371 23.5412L63.3956 21.9205C63.263 22.0066 63.0708 22.0829 62.8189 22.1491C62.5736 22.2154 62.3052 22.2784 62.0135 22.3381C61.7285 22.3911 61.4401 22.4408 61.1484 22.4872C60.8568 22.527 60.5949 22.5668 60.3629 22.6065C59.8525 22.6795 59.3951 22.7955 58.9908 22.9545C58.5864 23.1136 58.2583 23.3291 58.0064 23.6009C57.7545 23.866 57.5987 24.1974 57.5391 24.5952C57.4463 25.1719 57.5821 25.6127 57.9467 25.9176C58.3179 26.2159 58.8317 26.3651 59.4879 26.3651ZM84.2216 18.0824L80.3736 18.321C80.3537 17.983 80.2609 17.6813 80.0952 17.4162C79.9361 17.1444 79.7008 16.929 79.3892 16.7699C79.0843 16.6108 78.6998 16.5312 78.2358 16.5312C77.5398 16.5312 76.92 16.6903 76.3764 17.0085C75.8329 17.3267 75.5246 17.7344 75.4517 18.2315C75.392 18.5497 75.4749 18.8182 75.7003 19.0369C75.9257 19.2557 76.3797 19.4413 77.0625 19.5938L79.7472 20.1506C81.179 20.4555 82.2131 20.9626 82.8494 21.6719C83.4924 22.3812 83.7211 23.3092 83.5355 24.456C83.3698 25.4304 82.9422 26.2822 82.2528 27.0114C81.5634 27.7339 80.6884 28.2973 79.6278 28.7017C78.5672 29.0994 77.3906 29.2983 76.098 29.2983C74.0232 29.2983 72.4455 28.8741 71.3651 28.0256C70.2846 27.1771 69.7642 26.027 69.804 24.5753L73.9403 24.3565C73.9735 24.9796 74.1922 25.4503 74.5966 25.7685C75.0009 26.08 75.5545 26.2391 76.2571 26.2457C77.0459 26.259 77.7154 26.0966 78.2656 25.7585C78.8224 25.4138 79.1373 24.9962 79.2102 24.5057C79.2633 24.161 79.1638 23.8826 78.9119 23.6705C78.6667 23.4583 78.2159 23.2827 77.5597 23.1435L75.0142 22.6165C73.5691 22.3182 72.5317 21.7846 71.902 21.0156C71.2723 20.2467 71.0568 19.2689 71.2557 18.0824C71.4148 17.1345 71.8092 16.3224 72.4389 15.6463C73.0753 14.9635 73.8939 14.4399 74.8949 14.0753C75.9025 13.7107 77.0393 13.5284 78.3054 13.5284C80.2874 13.5284 81.7789 13.9361 82.7798 14.7514C83.7874 15.5668 84.268 16.6771 84.2216 18.0824ZM96.1062 13.7273L95.5792 16.9091H86.3718L86.9087 13.7273H96.1062ZM89.5934 10.0682H93.8292L91.4627 24.3068C91.3964 24.6979 91.4064 25.0028 91.4925 25.2216C91.5787 25.4337 91.7212 25.5829 91.9201 25.669C92.1256 25.7552 92.3709 25.7983 92.6559 25.7983C92.8548 25.7983 93.0569 25.7817 93.2624 25.7486C93.4679 25.7088 93.6237 25.679 93.7298 25.6591L93.8888 28.8111C93.6502 28.884 93.3287 28.9635 92.9244 29.0497C92.5266 29.1359 92.056 29.1889 91.5124 29.2088C90.4783 29.2486 89.6033 29.1127 88.8874 28.8011C88.1715 28.483 87.6578 27.9957 87.3462 27.3395C87.0347 26.6832 86.9684 25.858 87.1474 24.8636L89.5934 10.0682ZM96.32 29L98.8654 13.7273H103.101L100.556 29H96.32ZM101.421 11.7386C100.791 11.7386 100.271 11.5298 99.8597 11.1122C99.4554 10.688 99.2897 10.1842 99.3626 9.60085C99.4355 9.00426 99.7205 8.50047 100.218 8.08949C100.715 7.67187 101.278 7.46307 101.908 7.46307C102.538 7.46307 103.051 7.67187 103.449 8.08949C103.847 8.50047 104.013 9.00426 103.946 9.60085C103.88 10.1842 103.598 10.688 103.101 11.1122C102.611 11.5298 102.051 11.7386 101.421 11.7386ZM114.827 22.4972L116.288 13.7273H120.524L117.979 29H113.912L114.369 26.2259H114.21C113.74 27.1207 113.054 27.84 112.152 28.3835C111.25 28.9271 110.226 29.1989 109.08 29.1989C108.059 29.1989 107.197 28.9669 106.494 28.5028C105.798 28.0388 105.304 27.3793 105.013 26.5241C104.721 25.669 104.671 24.6449 104.864 23.4517L106.494 13.7273H110.73L109.239 22.696C109.099 23.5975 109.225 24.3101 109.616 24.8338C110.008 25.3575 110.604 25.6193 111.406 25.6193C111.917 25.6193 112.411 25.5033 112.888 25.2713C113.372 25.0327 113.789 24.6813 114.141 24.2173C114.492 23.7533 114.721 23.1799 114.827 22.4972ZM121.397 29L123.942 13.7273H127.969L127.532 16.4219H127.701C128.165 15.527 128.811 14.821 129.64 14.304C130.475 13.7869 131.413 13.5284 132.453 13.5284C133.488 13.5284 134.329 13.7902 134.979 14.3139C135.635 14.831 136.013 15.5336 136.113 16.4219H136.272C136.722 15.5469 137.402 14.8475 138.31 14.3239C139.218 13.7936 140.232 13.5284 141.353 13.5284C142.765 13.5284 143.845 13.9825 144.594 14.8906C145.343 15.7988 145.578 17.0781 145.3 18.7287L143.59 29H139.354L140.945 19.5639C141.071 18.7088 140.945 18.0724 140.567 17.6548C140.189 17.2306 139.662 17.0185 138.986 17.0185C138.217 17.0185 137.578 17.2637 137.067 17.7543C136.557 18.2382 136.242 18.8778 136.123 19.6733L134.542 29H130.435L132.046 19.4744C132.158 18.7187 132.036 18.1222 131.678 17.6847C131.327 17.2405 130.8 17.0185 130.097 17.0185C129.633 17.0185 129.192 17.1378 128.775 17.3764C128.364 17.6084 128.016 17.9366 127.73 18.3608C127.445 18.7784 127.26 19.2689 127.174 19.8324L125.623 29H121.397Z"
                        />
                    </svg>
                </NuxtLink>
            </div>
            <div class="flex-1 flex justify-center">
                <UTabs
                    v-if="mode === 'app'"
                    v-model="activeTab"
                    :items="items"
                    :content="false"
                    size="md"
                    color="neutral"
                    variant="pill"
                    class="bg-gray-800/50 rounded-full"
                />
            </div>

            <div class="flex items-center gap-6">
                <ULocaleSelect
                    v-model="selectedLocale"
                    :locales="[locales.en, locales.fr, locales.pl]"
                    class="w-36"
                />
                <!-- User Profile Dropdown (app mode only) -->
                <UDropdownMenu v-if="mode === 'app'" :items="userMenuItems">
                    <UButton color="neutral" variant="ghost" class="rounded-full p-0">
                        <UAvatar v-if="userAvatar" :src="userAvatar" :alt="userName" size="md" />
                        <UAvatar
                            v-else
                            :text="userInitials || '?'"
                            size="md"
                            class="bg-castium-green text-white"
                        />
                    </UButton>
                </UDropdownMenu>
                <UButton
                    v-if="mode === 'landing'"
                    class="[&_svg]:h-7 [&_svg]:w-7"
                    icon="i-heroicons-user-circle"
                    size="md"
                    color="neutral"
                    variant="outline"
                    label="Login"
                    :to="$localePath('/auth/login')"
                />
            </div>
        </div>
    </header>
</template>
